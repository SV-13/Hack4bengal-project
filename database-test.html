<!DOCTYPE html>
<html>
<head>
    <title>Supabase Database Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Database Connection Test</h1>
    <div id="results"></div>

    <script>
        const supabaseUrl = 'https://tbhcyajaukyocniuugif.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiaGN5YWphdWt5b2NuaXV1Z2lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxODY4MzMsImV4cCI6MjA2NTc2MjgzM30.AXvo1YPw_YR0q_RRCatbLbZqM_g1gnrGPy1q2qKHrMw'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        async function testDatabase() {
            const results = document.getElementById('results')
            results.innerHTML = '<p>Testing database connection...</p>'
            
            try {
                // Test 1: Basic connection
                const { data: authData, error: authError } = await supabase.auth.getUser()
                results.innerHTML += `<h3>Auth Status:</h3><pre>${JSON.stringify({ authData, authError }, null, 2)}</pre>`
                
                // Test 2: Check if trust score tables exist
                const { data: trustScores, error: trustError } = await supabase
                    .from('user_trust_scores')
                    .select('*')
                    .limit(1)
                
                results.innerHTML += `<h3>Trust Score Table Test:</h3><pre>${JSON.stringify({ trustScores, trustError }, null, 2)}</pre>`
                
                // Test 3: Check notification tables
                const { data: notifications, error: notifError } = await supabase
                    .from('user_notification_preferences')
                    .select('*')
                    .limit(1)
                
                results.innerHTML += `<h3>Notification Preferences Table Test:</h3><pre>${JSON.stringify({ notifications, notifError }, null, 2)}</pre>`
                
                // Test 4: Check loan agreements
                const { data: loans, error: loanError } = await supabase
                    .from('loan_agreements')
                    .select('*')
                    .limit(1)
                
                results.innerHTML += `<h3>Loan Agreements Table Test:</h3><pre>${JSON.stringify({ loans, loanError }, null, 2)}</pre>`
                  // Test 5: Try RPC function
                const { data: rpcData, error: rpcError } = await supabase.rpc('initialize_user_trust_score', {
                    p_user_id: '00000000-0000-0000-0000-000000000000'
                })
                
                results.innerHTML += `<h3>RPC Function Test:</h3><pre>${JSON.stringify({ rpcData, rpcError }, null, 2)}</pre>`
                
                // Test 6: Check trust score history table
                const { data: history, error: historyError } = await supabase
                    .from('trust_score_history')
                    .select('*')
                    .limit(1)
                
                results.innerHTML += `<h3>Trust Score History Table Test:</h3><pre>${JSON.stringify({ history, historyError }, null, 2)}</pre>`
                
                // Test 7: Check user ratings table
                const { data: ratings, error: ratingsError } = await supabase
                    .from('user_ratings')
                    .select('*')
                    .limit(1)
                
                results.innerHTML += `<h3>User Ratings Table Test:</h3><pre>${JSON.stringify({ ratings, ratingsError }, null, 2)}</pre>`
                
                // Test 8: Test calculate_trust_score function
                const { data: calcData, error: calcError } = await supabase.rpc('calculate_trust_score', {
                    p_user_id: '00000000-0000-0000-0000-000000000000'
                })
                
                results.innerHTML += `<h3>Calculate Trust Score Function Test:</h3><pre>${JSON.stringify({ calcData, calcError }, null, 2)}</pre>`
                
            } catch (error) {
                results.innerHTML += `<h3>Error:</h3><pre>${error.message}</pre>`
            }
        }
        
        // Run test when page loads
        testDatabase()
    </script>
</body>
</html>
